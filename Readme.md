### 记录拼接算法pipeline速度

#### v0.5.1 测试
目的\
1、测试优化后的融合算法的极限进程速度

配置
|显卡|cpu|torch|进程|图片数量|图片尺寸|LightGlue|融合|重叠区域宽度|时间|
|----|----|----|----|----|----|----|----|----|----|
|3090|E5-2683 v3|2.4.0+cu118|12|1335|4000*3375|SuperPoint+LightGlue|相加+cuda|200|20241028_1148|

运行结果
|运行次数|7进程|12进程|
|----|----|----|
|第一次|367.485|274.753|
|第二次|329.537|277.102|
|第三次|331.810|276.655|

#### v0.5 测试
目的\
1、测试优化后的加权融合算法速度

配置
|显卡|cpu|torch|进程|图片数量|图片尺寸|LightGlue|融合|重叠区域宽度|时间|
|----|----|----|----|----|----|----|----|----|----|
|3090|E5-2683 v3|2.4.0+cu118|7|1335|4000*3375|SuperPoint+LightGlue|相加+cuda|200|20241028_1148|

运行结果
|运行次数|旧-直接拼接|新-加权融合|
|----|----|----|
|第一次|622.970|367.485|
|第二次|612.979|329.537|
|第三次|612.979|331.810|

#### v0.4 测试
目的\
1、测试cv读取数据集的速度与dataloader读取数据集速度之差

配置\
硬件、依赖配置如v0.3

运行结果
|运行次数|14进程处理100组数据集|dataloader处理100组数据集|
|----|----|----|
|第一次|18.218|~>18.218|
|第二次|18.537|~>18.218|
|第三次|18.197|~>18.218|

结论\
1、dataloader后续图片处理耗时拖累了速度，还是cv速度快
2、图像提前处理存储，内存不够

待更改点：\
1、图像融合改为效果更好但更耗时\


#### v0.3 测试
目的\
1、测试lightglue提取器和加载器能否前置调用，以及提升的速度如何

配置
|显卡|cpu|torch|进程|图片尺寸|LightGlue|融合|重叠区域宽度|时间|
|----|----|----|----|----|----|----|----|----|
|3090|E5-2683 v3|2.4.0+cu118|7|4000*3375|SuperPoint+LightGlue|相加+cuda|200|20240929_1742|

运行结果
|运行次数|拼接100组图片7进程耗时|
|----|----|
|第一次|50.890|
|第二次|53.926|
|第三次|51.237|

结论\
1、可以前置调用，速度提升明显

遗留问题\
1、7进程也偶尔出现了显存溢出的问题

待更改点：\
1、图像融合改为效果更好但更耗时\
2、图像读取提前处理

#### v0.2.4 测试 | 一批图片多次运行
目的\
1、测试transformer转张量处理一批图像的速度提升

配置
|显卡|cpu|torch|进程|图片尺寸|LightGlue|融合|重叠区域宽度|时间|
|----|----|----|----|----|----|----|----|----|
|3090|E5-2683 v3|2.4.0+cu118|7|4000*3375|SuperPoint+LightGlue|相加+cuda|200|20240929_1742|

运行结果
|运行次数|拼接100组图片7进程耗时|
|----|----|
|第一次|60.701|
|第二次|61.922|
|第三次|62.058|
|第四次|60.192|

#### v0.2.3 验证
目的\
1、测试v0.2待验证2

配置\
v0.2除lightglue其他不变

运行结果\
有bug，遂止

#### v0.2.2 验证
目的\
1、测试v0.2待验证1

配置\
v0.2硬件、依赖配置不变，单独测试转换时间

运行时间/s
|运行次数|lightglue转换50次耗时|transformer转换50次耗时|
|----|----|----|
|第一次|15.430|6.166|
|第二次|16.159|5.837|
|第三次|16.029|5.398|

结论\
1、transformer转张量速度快于lightglue方法

#### v0.2.1 测试 | 一批图片多次运行
目的\
1、记录v0.2配置一批文件处理时间

配置
|显卡|cpu|torch|进程|图片尺寸|LightGlue|融合|重叠区域宽度|时间|
|----|----|----|----|----|----|----|----|----|
|3090|E5-2683 v3|2.4.0+cu118|7&8|4000*3375|SuperPoint+LightGlue|相加+cuda|200|20240929_1642|

运行结果
|运行次数|拼接100组图片8进程耗时|拼接100组图片7进程耗时|
|----|----|----|
|第一次|60.137|64.323|
|第二次|60.979|64.079|
|第三次|60.064|64.306|

结论\
1、此配置8进程有显存溢出风险，暂定后续7进程测试
2、平均每组图像拼接速度为0.64s

遗留问题\
1、显存溢出风险解决

#### v0.2 测试 | 不同图片单次多轮运行
目的\
1、探究CPU,GPU更改后各模块时间分布是否有变化\
2、以图像尺寸4000*3375为基准测试

配置
|显卡|cpu|torch|进程池|图片尺寸|LightGlue|融合|重叠区域宽度|时间|
|----|----|----|----|----|----|----|----|----|
|3090|E5-2683 v3|2.4.0+cu118|No|4000*3375|SuperPoint+LightGlue|相加+cuda|200|20240929_1119|

运行时间/s
|运行轮数|总耗时|cv读取图像|图像转张量|加载提取器和匹配器|LightGlue剩余算法|计算单应矩阵|图像透视变换|图像融合|图像存储|
|----|----|----|----|----|----|----|----|----|----|
|第一轮|3.410|0.215|0.986|0.356|0.652|0.046|0.106|0.866|0.180|
|第二轮|2.212|0.234|0.557|0.274|0.067|0.046|0.030|0.862|0.138|
|第三轮|2.106|0.156|0.567|0.228|0.059|0.043|0.052|0.853|0.144|
|第四轮|2.230|0.147|0.570|0.234|0.061|0.043|0.050|0.970|0.146|

结论：\
1、耗时部分分布与v0.1测试的结果一致，图像融合和读取图像占主要时间，其次是特征匹配\
2、第一轮与cuda相关的操作会耗时多一些，对于多批次的任务来说影响不大\

待验证：\
1、调用transformer测试转张量的速度是否提升\
2、测试lightglue最高速度方案效果

待更改点：\
1、lightglue提取器和匹配器提前调取\
2、图像融合改为效果更好但更耗时\
3、图像读取提前处理

#### v0.1.1 验证
目的\
1、验证v0.1待验证条目

配置\
在v0.1配置不变的条件下，只改变第三次，第四次图片\

结论\
1、第一次后lightglue的提速与同一个图片多次运行无关，可认为v0.1测得的提速后的耗时是可作为整体耗时的样本的
#### v0.1 测试 | 同一图片单次多轮运行
目的\
1、探究流程各模块的运行时间分布

配置
|显卡|cpu|torch|进程池|图片尺寸|LightGlue|融合|重叠区域宽度|时间|
|----|----|----|----|----|----|----|----|----|
|1080ti|R7 2700X|2.4.0+cu118|No|4000*2000|SuperPoint+LightGlue|相加+cuda|200|20240927_102904|

运行时间/s
|运行轮数|总耗时|cv读取图像|图像转张量|加载提取器和匹配器|LightGlue剩余算法|计算单应矩阵|图像透视变换|图像融合|图像存储|
|----|----|----|----|----|----|----|----|----|----|
|第一轮|1.983|0.085|0.327|0.253|0.447|0.027|0.092|0.698|0.052|
|第二轮|1.033|0.074|0.239|0.158|0.082|0.026|0.053|0.344|0.050|
|第三轮|0.969|0.070|0.208|0.151|0.074|0.027|0.024|0.354|0.049|
|第四轮|0.968|0.071|0.208|0.150|0.068|0.025|0.023|0.354|0.055|

结论：\
1、耗时部分在于图像转张量、特征匹配和融合上\
2、第一组拼接耗时多于后续拼接组，体现在图像转张量、特征匹配和融合上\

待验证：\
1、lightglue提速是否和同一个图片多次运行有关\

待更改点：\
1、图像由4000 * 2000变为4000 * 3375\
2、lightglue提取器和匹配器提前调取\
3、图像融合改为效果更好但更耗时\
4、lightglue启用FlashAttention

### 测试记录-从前
800张，4进程，3090，融合cuda，scale1=400，3375*4000： 1042s； 
800张，1进程，3090，融合cuda，scale1=400，3375*4000： 2842s; 9830MB;
800张，1进程，3090，融合cpu ，scale1=400，3375*4000： 2144s；4915MB;
800张，4进程，3090，融合cuda，scale1=400，3375*4000： 956s； 
800张，4进程，3090，融合cuda，scale1=400，2000*4000： 668s；
800张，5进程，3090，[2000*4000], 587s； 
800张，4进程，3090，[2000*4000]，681s； 
800张，4进程，1080ti，[2000*4000]，782s
800张，7进程，3090，[2000*4000]，492s； 
800张，8进程，3090，[2000*4000]，463s；
# imgStitch
# imgStitch
